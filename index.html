<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ASUS Market Pulse</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
      }
      /* Custom scrollbar for better look */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1; 
      }
      ::-webkit-scrollbar-thumb {
        background: #c1c1c1; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8; 
      }
    </style>

    <!-- Import Map to handle external libraries -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0",
    "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-type="module" data-presets="typescript,react">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            Camera, X, Loader2, Save, ArrowLeft, CheckCircle2, 
            ChevronRight, PlusCircle, Pencil, Trash2, LayoutDashboard,
            Download, Plus, Calendar, ChevronDown, ChevronUp 
        } from 'lucide-react';
        import { 
            BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell 
        } from 'recharts';
        import { GoogleGenAI, Type } from "@google/genai";

        // --- MOCK PROCESS.ENV FOR BROWSER ---
        // TODO: Enter your API Key below if you want to use the AI features.
        // If left empty, the app will run in "Demo Mode" (Manual entry only).
        window.process = {
            env: {
                API_KEY: '' 
            }
        };

        // --- TYPES & CONSTANTS (from types.ts) ---
        
        // Note: Interfaces are stripped by Babel at runtime, but kept here for structure
        /*
        interface CompetitorEntry {
          id: string;
          date: string;
          brand: string;
          modelName: string;
          finalMSRP: number;
          promotion: string;
          imageUrl?: string;
        }
        interface TargetModel {
          id: string;
          brand: string;
          model: string;
        }
        */

        const AppView = {
          DASHBOARD: 'DASHBOARD',
          NEW_ENTRY: 'NEW_ENTRY'
        };

        const DEFAULT_TARGETS = [
          { id: '1', brand: 'Apple', model: 'MacBook Air 13 (M3)' },
          { id: '2', brand: 'Apple', model: 'MacBook Air 15 (M3)' },
          { id: '3', brand: 'HP', model: 'Spectre x360 14' },
          { id: '4', brand: 'HP', model: 'Pavilion Plus 14' },
          { id: '5', brand: 'Lenovo', model: 'Yoga 9i 2-in-1' },
          { id: '6', brand: 'Lenovo', model: 'Slim 7i Gen 9' },
          { id: '7', brand: 'Dell', model: 'XPS 13' },
          { id: '8', brand: 'Dell', model: 'Inspiron 14 Plus' },
          { id: '9', brand: 'Acer', model: 'Swift Go 14' },
          { id: '10', brand: 'MSI', model: 'Prestige 13 AI Evo' }
        ];

        const COMMON_BRANDS = [
          'Acer', 'HP', 'Lenovo', 'Dell', 'MSI', 'Apple', 
          'Samsung', 'Microsoft', 'Gigabyte', 'Razer', 'LG', 'Asus'
        ];

        const getWeekLabel = (dateString) => {
          const date = new Date(dateString);
          const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
          const dayNum = d.getUTCDay() || 7;
          d.setUTCDate(d.getUTCDate() + 4 - dayNum);
          const year = d.getUTCFullYear();
          const weekNo = Math.ceil((((d.getTime() - new Date(Date.UTC(year, 0, 1)).getTime()) / 86400000) + 1) / 7);
          return `${year}-W${weekNo.toString().padStart(2, '0')}`;
        };

        const getWeekRange = (weekLabel) => {
          const [yearStr, weekStr] = weekLabel.split('-W');
          const year = parseInt(yearStr);
          const week = parseInt(weekStr);
          
          const simple = new Date(year, 0, 1 + (week - 1) * 7);
          const dayOfWeek = simple.getDay();
          const ISOweekStart = simple;
          if (dayOfWeek <= 4) 
              ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
          else 
              ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
              
          const end = new Date(ISOweekStart);
          end.setDate(end.getDate() + 6);
          
          return `${ISOweekStart.toLocaleDateString(undefined, {month:'short', day:'numeric'})} - ${end.toLocaleDateString(undefined, {month:'short', day:'numeric'})}`;
        };

        // --- GEMINI SERVICE (from services/geminiService.ts) ---

        const getAiClient = () => {
          const apiKey = window.process.env.API_KEY;
          if (!apiKey) {
            throw new Error("API Key not found");
          }
          return new GoogleGenAI({ apiKey });
        };

        const extractDataFromImage = async (base64Image) => {
          const ai = getAiClient();
          const modelId = "gemini-2.5-flash-image";

          const prompt = `
            Analyze this image of a laptop or electronics price tag/spec sheet.
            Extract the following information:
            1. Brand Name (e.g., Acer, HP, Lenovo).
            2. Model Name/Number (be precise).
            3. Final Price/MSRP (numeric only, strip currency symbols).
            4. Any mentions of promotions, discounts, or special specs (e.g., "Free mouse", "Student discount", "RTX 4060").
            
            If you cannot find a specific field, make a reasonable guess based on visible text or leave it blank/0.
          `;

          try {
            const response = await ai.models.generateContent({
              model: modelId,
              contents: {
                parts: [
                  {
                    inlineData: {
                      mimeType: "image/jpeg",
                      data: base64Image,
                    },
                  },
                  { text: prompt },
                ],
              },
              config: {
                responseMimeType: "application/json",
                responseSchema: {
                  type: Type.OBJECT,
                  properties: {
                    brand: { type: Type.STRING },
                    modelName: { type: Type.STRING },
                    finalMSRP: { type: Type.NUMBER },
                    promotion: { type: Type.STRING },
                  },
                  required: ["brand", "modelName", "finalMSRP"],
                },
              },
            });

            const text = response.text;
            if (!text) throw new Error("No response from AI");
            return JSON.parse(text);
          } catch (error) {
            console.error("Gemini Extraction Error:", error);
            throw error;
          }
        };

        // --- COMPONENT: EntryForm (from components/EntryForm.tsx) ---

        const EntryForm = ({ availableTargets, onCreateTarget, onUpdateTarget, onDeleteTarget, onSave, onCancel }) => {
          const [step, setStep] = useState(1);
          
          const [targetFormMode, setTargetFormMode] = useState('none');
          const [editingTargetId, setEditingTargetId] = useState(null);
          
          const [targetBrand, setTargetBrand] = useState('');
          const [targetModel, setTargetModel] = useState('');

          const [selectedTarget, setSelectedTarget] = useState(null);

          const [finalMSRP, setFinalMSRP] = useState('');
          const [promotion, setPromotion] = useState('');
          const [imagePreview, setImagePreview] = useState(null);
          
          const [isAnalyzing, setIsAnalyzing] = useState(false);
          const [error, setError] = useState(null);
          
          const fileInputRef = useRef(null);

          const handleTargetSelect = (target) => {
            setSelectedTarget(target);
            setStep(2);
          };

          const startCreateTarget = () => {
            setTargetBrand('');
            setTargetModel('');
            setEditingTargetId(null);
            setTargetFormMode('create');
          };

          const startEditTarget = (target) => {
            setTargetBrand(target.brand);
            setTargetModel(target.model);
            setEditingTargetId(target.id);
            setTargetFormMode('edit');
          };

          const handleTargetFormSubmit = (e) => {
            e.preventDefault();
            if (!targetBrand || !targetModel) return;

            if (targetFormMode === 'create') {
                const newTarget = {
                    id: crypto.randomUUID(),
                    brand: targetBrand,
                    model: targetModel
                };
                onCreateTarget(newTarget);
                setSelectedTarget({ brand: targetBrand, model: targetModel });
                setStep(2);
            } else if (targetFormMode === 'edit' && editingTargetId) {
                onUpdateTarget({
                    id: editingTargetId,
                    brand: targetBrand,
                    model: targetModel
                });
                setTargetFormMode('none');
                setEditingTargetId(null);
            }
          };

          const handleFileChange = async (event) => {
            const file = event.target.files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = async () => {
              const base64String = reader.result;
              setImagePreview(base64String);
              await analyzeImage(base64String.split(',')[1]);
            };
            reader.readAsDataURL(file);
          };

          const analyzeImage = async (base64Data) => {
            setIsAnalyzing(true);
            setError(null);
            try {
              const data = await extractDataFromImage(base64Data);
              if (data.finalMSRP) setFinalMSRP(data.finalMSRP.toString());
              if (data.promotion) setPromotion(data.promotion);
            } catch (err) {
              setError("Could not analyze image. Please enter price manually.");
            } finally {
              setIsAnalyzing(false);
            }
          };

          const handleSubmit = (e) => {
            e.preventDefault();
            if (!selectedTarget || !finalMSRP) {
              setError("Please fill in price.");
              return;
            }

            const newEntry = {
              id: crypto.randomUUID(),
              date: new Date().toISOString(),
              brand: selectedTarget.brand,
              modelName: selectedTarget.model,
              finalMSRP: parseFloat(finalMSRP),
              promotion: promotion || 'None',
              imageUrl: imagePreview || undefined
            };

            onSave(newEntry);
          };

          if (step === 1) {
            if (targetFormMode !== 'none') {
              return (
                <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                  <div className="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50">
                    <button onClick={() => setTargetFormMode('none')} className="text-gray-500 hover:text-gray-700 flex items-center gap-1 text-sm font-medium">
                      <ArrowLeft size={16} /> Cancel
                    </button>
                    <h2 className="text-lg font-semibold text-gray-800">
                        {targetFormMode === 'create' ? 'Add New Model' : 'Edit Model'}
                    </h2>
                    <div className="w-12"></div>
                  </div>
                  <div className="p-6">
                    <form onSubmit={handleTargetFormSubmit} className="space-y-4">
                       <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Brand Name</label>
                        <input
                          list="brands"
                          type="text"
                          required
                          value={targetBrand}
                          onChange={(e) => setTargetBrand(e.target.value)}
                          placeholder="e.g. Razer"
                          className="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                        />
                        <datalist id="brands">
                          {COMMON_BRANDS.map(b => <option key={b} value={b} />)}
                        </datalist>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Model Name / Number</label>
                        <input
                          type="text"
                          required
                          value={targetModel}
                          onChange={(e) => setTargetModel(e.target.value)}
                          placeholder="e.g. Blade 14 (2024)"
                          className="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                        />
                      </div>
                      <button
                        type="submit"
                        className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 shadow-sm mt-4"
                      >
                        {targetFormMode === 'create' ? 'Create & Select' : 'Save Changes'}
                      </button>
                    </form>
                  </div>
                </div>
              );
            }

            return (
              <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div className="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50">
                  <button onClick={onCancel} className="text-gray-500 hover:text-gray-700 flex items-center gap-1 text-sm font-medium">
                    <ArrowLeft size={16} /> Back
                  </button>
                  <h2 className="text-lg font-semibold text-gray-800">Select Target Model</h2>
                  <div className="w-12"></div>
                </div>
                
                <div className="p-4">
                  <button 
                    onClick={startCreateTarget}
                    className="w-full flex items-center justify-center gap-2 p-3 mb-4 rounded-lg border-2 border-dashed border-blue-300 text-blue-600 bg-blue-50 hover:bg-blue-100 transition-colors font-semibold"
                  >
                    <PlusCircle size={20} />
                    Create New Model
                  </button>

                  <p className="text-xs text-gray-500 mb-2 px-2 uppercase font-semibold tracking-wider">Existing Targets</p>
                  <div className="space-y-3">
                    {availableTargets.map((target, idx) => (
                      <div 
                        key={target.id || idx} 
                        className="w-full flex items-center p-3 rounded-lg border border-gray-200 hover:border-blue-400 hover:bg-blue-50 transition-all bg-white group shadow-sm"
                      >
                        <button 
                            onClick={() => handleTargetSelect(target)}
                            className="flex-1 text-left"
                        >
                            <div className="font-semibold text-gray-900 group-hover:text-blue-700">{target.model}</div>
                            <div className="text-sm text-gray-500">{target.brand}</div>
                        </button>
                        
                        <div className="flex items-center gap-1 border-l border-gray-200 pl-3 ml-2">
                            <button 
                                onClick={(e) => { e.stopPropagation(); startEditTarget(target); }}
                                className="p-2 text-gray-400 hover:text-blue-600 hover:bg-white rounded-md transition-colors"
                                title="Edit Model"
                            >
                                <Pencil size={18} />
                            </button>
                            <button 
                                onClick={(e) => { e.stopPropagation(); onDeleteTarget(target.id); }}
                                className="p-2 text-gray-400 hover:text-red-600 hover:bg-white rounded-md transition-colors"
                                title="Delete Model"
                            >
                                <Trash2 size={18} />
                            </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            );
          }

          return (
            <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
              <div className="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50">
                <button 
                  onClick={() => setStep(1)}
                  className="text-gray-500 hover:text-gray-700 flex items-center gap-1 text-sm font-medium"
                >
                  <ArrowLeft size={16} /> Change Model
                </button>
                <h2 className="text-lg font-semibold text-gray-800">Update Price</h2>
                <div className="w-12"></div>
              </div>

              <div className="p-6">
                <div className="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-6 flex items-start gap-3">
                    <CheckCircle2 className="text-blue-600 mt-0.5" size={20} />
                    <div>
                        <p className="text-xs text-blue-600 font-bold uppercase tracking-wider">Target Model</p>
                        <h3 className="text-lg font-bold text-gray-900">{selectedTarget?.model}</h3>
                        <p className="text-sm text-gray-600">{selectedTarget?.brand}</p>
                    </div>
                </div>

                <div className="mb-8">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Scan Price Tag (Optional)
                  </label>
                  <div 
                    onClick={() => fileInputRef.current?.click()}
                    className={`
                      relative border-2 border-dashed rounded-lg p-6 flex flex-col items-center justify-center cursor-pointer transition-colors
                      ${imagePreview ? 'border-blue-300 bg-blue-50' : 'border-gray-300 hover:border-blue-400 hover:bg-gray-50'}
                    `}
                  >
                    <input 
                      type="file" 
                      ref={fileInputRef} 
                      className="hidden" 
                      accept="image/*" 
                      capture="environment" 
                      onChange={handleFileChange}
                    />
                    
                    {isAnalyzing ? (
                      <div className="text-center py-4">
                        <Loader2 className="animate-spin h-10 w-10 text-blue-600 mx-auto mb-2" />
                        <p className="text-blue-700 font-medium">Extracting Price...</p>
                      </div>
                    ) : imagePreview ? (
                      <div className="relative w-full max-h-48 flex justify-center">
                         <img src={imagePreview} alt="Preview" className="max-h-48 rounded-md object-contain" />
                         <button 
                            onClick={(e) => { e.stopPropagation(); setImagePreview(null); setFinalMSRP(''); setPromotion(''); }}
                            className="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full shadow-md hover:bg-red-600"
                         >
                           <X size={16} />
                         </button>
                      </div>
                    ) : (
                      <div className="text-center">
                        <div className="bg-blue-100 p-3 rounded-full inline-flex mb-3 text-blue-600">
                          <Camera size={24} />
                        </div>
                        <p className="text-gray-900 font-medium">Tap to take photo</p>
                      </div>
                    )}
                  </div>
                  {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                </div>

                <form onSubmit={handleSubmit} className="space-y-5">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-500 mb-1">Brand</label>
                        <input
                        type="text"
                        value={selectedTarget?.brand}
                        readOnly
                        className="w-full rounded-md border border-gray-200 bg-gray-100 px-3 py-2 text-gray-500 cursor-not-allowed"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-500 mb-1">Model</label>
                        <input
                        type="text"
                        value={selectedTarget?.model}
                        readOnly
                        className="w-full rounded-md border border-gray-200 bg-gray-100 px-3 py-2 text-gray-500 cursor-not-allowed"
                        />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Final MSRP ($) *</label>
                    <input
                        type="number"
                        value={finalMSRP}
                        onChange={(e) => setFinalMSRP(e.target.value)}
                        placeholder="0.00"
                        className="w-full rounded-md border border-gray-300 px-3 py-2 text-lg font-medium text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                        autoFocus
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Other Promotion / Notes</label>
                    <textarea
                      value={promotion}
                      onChange={(e) => setPromotion(e.target.value)}
                      placeholder="e.g. Free backpack, 5% off student discount"
                      rows={3}
                      className="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                    />
                  </div>

                  <div className="pt-4 flex gap-3">
                     <button
                      type="button"
                      onClick={onCancel}
                      className="flex-1 bg-white text-gray-700 border border-gray-300 px-4 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      className="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 shadow-sm flex justify-center items-center gap-2 transition-colors"
                    >
                      <Save size={18} />
                      Save
                    </button>
                  </div>
                </form>
              </div>
            </div>
          );
        };

        // --- COMPONENT: WeekSection (from components/Dashboard.tsx) ---

        const WeekSection = ({ weekLabel, entries, isExpandedDefault, onDelete }) => {
            const [isExpanded, setIsExpanded] = useState(isExpandedDefault);
            const dateRange = getWeekRange(weekLabel);
            
            const avgPrice = Math.round(entries.reduce((sum, e) => sum + e.finalMSRP, 0) / entries.length);
            const brandsCount = new Set(entries.map(e => e.brand)).size;

            const chartData = Object.values(entries.reduce((acc, curr) => {
                if (!acc[curr.brand]) acc[curr.brand] = { name: curr.brand, total: 0, count: 0 };
                acc[curr.brand].total += curr.finalMSRP;
                acc[curr.brand].count += 1;
                return acc;
            }, {}))
            .map((item) => ({ name: item.name, avgPrice: Math.round(item.total / item.count) }))
            .sort((a, b) => b.avgPrice - a.avgPrice);

            return (
                <div className="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                    <div 
                        className="p-5 flex flex-col sm:flex-row sm:items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors"
                        onClick={() => setIsExpanded(!isExpanded)}
                    >
                        <div className="flex items-center gap-4">
                            <div className="bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg text-sm font-bold border border-blue-100">
                                {weekLabel}
                            </div>
                            <div>
                                <h3 className="font-semibold text-gray-900">{dateRange}</h3>
                                <p className="text-xs text-gray-500">{entries.length} entries reported â€¢ {brandsCount} brands</p>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-4 mt-4 sm:mt-0">
                            <div className="text-right hidden sm:block">
                                <p className="text-xs text-gray-400 uppercase font-semibold">Weekly Avg</p>
                                <p className="font-bold text-gray-800">${avgPrice.toLocaleString()}</p>
                            </div>
                            {isExpanded ? <ChevronUp size={20} className="text-gray-400" /> : <ChevronDown size={20} className="text-gray-400" />}
                        </div>
                    </div>

                    {isExpanded && (
                        <div className="border-t border-gray-100">
                            <div className="p-6 bg-gray-50 border-b border-gray-100 grid grid-cols-1 md:grid-cols-3 gap-6">
                                 <div className="col-span-2 h-40">
                                    <h4 className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wide">Avg Price Distribution</h4>
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={chartData} layout="vertical" margin={{ left: 20 }}>
                                            <XAxis type="number" hide />
                                            <YAxis dataKey="name" type="category" width={80} tick={{fontSize: 11}} axisLine={false} tickLine={false} />
                                            <Tooltip cursor={{fill: 'transparent'}} contentStyle={{borderRadius: '6px', fontSize: '12px'}} />
                                            <Bar dataKey="avgPrice" fill="#94a3b8" barSize={16} radius={[0, 4, 4, 0]}>
                                                 {chartData.map((entry, index) => (
                                                    <Cell key={`cell-${index}`} fill={entry.name === 'ASUS' ? '#00539B' : '#64748b'} />
                                                ))}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                 </div>
                                 <div className="flex flex-col justify-center text-sm text-gray-600">
                                     <p className="mb-2">Top Promotion:</p>
                                     <div className="bg-white p-3 rounded border border-gray-200 italic text-gray-800">
                                         "{entries.find(e => e.promotion && e.promotion !== 'None')?.promotion || 'No major promos'}"
                                     </div>
                                 </div>
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm text-gray-600">
                                    <thead className="bg-white text-xs uppercase font-semibold text-gray-400 border-b border-gray-100">
                                        <tr>
                                        <th className="px-6 py-3 pl-8">Model</th>
                                        <th className="px-6 py-3">Price</th>
                                        <th className="px-6 py-3">Promo</th>
                                        <th className="px-6 py-3 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-50">
                                        {entries.map((entry) => (
                                        <tr key={entry.id} className="hover:bg-gray-50">
                                            <td className="px-6 py-3 pl-8">
                                                <div className="font-medium text-gray-900">{entry.modelName}</div>
                                                <div className="text-xs text-gray-500">{entry.brand}</div>
                                            </td>
                                            <td className="px-6 py-3 font-medium text-gray-900">
                                                ${entry.finalMSRP.toLocaleString()}
                                            </td>
                                            <td className="px-6 py-3 max-w-xs truncate text-gray-500">
                                                {entry.promotion}
                                            </td>
                                            <td className="px-6 py-3 text-right">
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); onDelete(entry.id); }}
                                                    className="text-gray-300 hover:text-red-500 transition-colors"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </td>
                                        </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- COMPONENT: Dashboard (from components/Dashboard.tsx) ---

        const Dashboard = ({ entries, onAddClick, onDelete }) => {
          const groupedEntries = useMemo(() => {
            const groups = {};
            entries.forEach(entry => {
              const weekLabel = getWeekLabel(entry.date);
              if (!groups[weekLabel]) groups[weekLabel] = [];
              groups[weekLabel].push(entry);
            });
            return Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0]));
          }, [entries]);

          const handleExport = () => {
            const headers = ['Week', 'Date', 'Brand', 'Model Name', 'Final MSRP', 'Promotion'];
            const csvContent = [
              headers.join(','),
              ...entries.map(e => {
                const week = getWeekLabel(e.date);
                const cleanPromo = `"${e.promotion.replace(/"/g, '""')}"`;
                const cleanModel = `"${e.modelName.replace(/"/g, '""')}"`;
                return [
                    week,
                    new Date(e.date).toLocaleDateString(), 
                    e.brand, 
                    cleanModel, 
                    e.finalMSRP, 
                    cleanPromo
                ].join(',');
              })
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `asus_competitor_report_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          return (
            <div className="space-y-6">
              <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                  <h1 className="text-2xl font-bold text-gray-900">Weekly Price Report</h1>
                  <p className="text-sm text-gray-500 mt-1">Track competitor pricing trends by week</p>
                </div>
                <div className="flex gap-2">
                   <button 
                    onClick={handleExport}
                    disabled={entries.length === 0}
                    className="flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2.5 rounded-lg hover:bg-gray-50 font-medium text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <Download size={18} />
                    Export All
                  </button>
                  <button 
                    onClick={onAddClick}
                    className="flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2.5 rounded-lg hover:bg-blue-700 font-medium text-sm shadow-sm transition-colors"
                  >
                    <Plus size={18} />
                    Update Price
                  </button>
                </div>
              </div>

              {groupedEntries.length === 0 ? (
                  <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
                    <div className="bg-gray-50 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                        <Calendar className="text-gray-400" size={32} />
                    </div>
                    <h3 className="text-lg font-medium text-gray-900">No reports yet</h3>
                    <p className="text-gray-500 mt-1 mb-6">Start by adding a price check for a competitor model.</p>
                    <button 
                        onClick={onAddClick}
                        className="bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-blue-700"
                    >
                        Start New Report
                    </button>
                  </div>
              ) : (
                  <div className="space-y-6">
                      {groupedEntries.map(([weekLabel, weekEntries], index) => (
                          <WeekSection 
                            key={weekLabel} 
                            weekLabel={weekLabel} 
                            entries={weekEntries} 
                            isExpandedDefault={index === 0}
                            onDelete={onDelete}
                          />
                      ))}
                  </div>
              )}
            </div>
          );
        };

        // --- COMPONENT: App (from App.tsx) ---

        const App = () => {
          const [view, setView] = useState(AppView.DASHBOARD);
          const [entries, setEntries] = useState([]);
          const [targets, setTargets] = useState(DEFAULT_TARGETS);
          const [apiKeyMissing, setApiKeyMissing] = useState(false);

          useEffect(() => {
            const savedEntries = localStorage.getItem('asus_competitor_data');
            if (savedEntries) {
              try { setEntries(JSON.parse(savedEntries)); } catch (e) { console.error(e); }
            }

            const savedTargets = localStorage.getItem('asus_competitor_targets');
            if (savedTargets) {
              try { setTargets(JSON.parse(savedTargets)); } catch (e) { console.error(e); }
            }

            if (!window.process.env.API_KEY) {
              setApiKeyMissing(true);
            }
          }, []);

          useEffect(() => {
            localStorage.setItem('asus_competitor_data', JSON.stringify(entries));
          }, [entries]);

          useEffect(() => {
            localStorage.setItem('asus_competitor_targets', JSON.stringify(targets));
          }, [targets]);

          const handleSaveEntry = (entry) => {
            setEntries(prev => [entry, ...prev]);
            setView(AppView.DASHBOARD);
          };

          const handleCreateTarget = (newTarget) => {
            setTargets(prev => [newTarget, ...prev]);
          };

          const handleUpdateTarget = (updatedTarget) => {
            setTargets(prev => prev.map(t => t.id === updatedTarget.id ? updatedTarget : t));
          };

          const handleDeleteTarget = (id) => {
            if (window.confirm("Are you sure you want to delete this model from the list?")) {
              setTargets(prev => prev.filter(t => t.id !== id));
            }
          };

          const handleDeleteEntry = (id) => {
            if (window.confirm("Are you sure you want to delete this entry?")) {
              setEntries(prev => prev.filter(e => e.id !== id));
            }
          };

          return (
            <div className="min-h-screen flex flex-col font-sans text-gray-900 bg-slate-50">
              <header className="bg-[#00539B] text-white shadow-lg sticky top-0 z-50">
                <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                  <div 
                    className="flex items-center gap-3 cursor-pointer" 
                    onClick={() => setView(AppView.DASHBOARD)}
                  >
                    <div className="bg-white p-1.5 rounded-lg">
                       <LayoutDashboard className="text-[#00539B]" size={20} />
                    </div>
                    <div>
                      <h1 className="font-bold text-lg tracking-tight leading-tight">Market Pulse</h1>
                      <p className="text-[10px] text-blue-200 uppercase tracking-widest font-semibold">Promoter Tool</p>
                    </div>
                  </div>
                  <div className="text-xs text-blue-100 hidden sm:block">
                    Internal Use Only
                  </div>
                </div>
              </header>

              <main className="flex-1 w-full max-w-5xl mx-auto p-4 sm:p-6">
                {apiKeyMissing && (
                  <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r-lg shadow-sm">
                    <div className="flex">
                      <div className="flex-shrink-0">
                        <svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                          <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                        </svg>
                      </div>
                      <div className="ml-3">
                        <p className="text-sm text-yellow-700">
                          <strong className="font-medium">Demo Mode Warning:</strong> No API Key detected (Check code line ~38). The "AI Scan" feature will not work, but manual entry and CSV export are functional.
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {view === AppView.DASHBOARD ? (
                  <Dashboard 
                    entries={entries} 
                    onAddClick={() => setView(AppView.NEW_ENTRY)}
                    onDelete={handleDeleteEntry}
                  />
                ) : (
                  <EntryForm 
                    availableTargets={targets}
                    onCreateTarget={handleCreateTarget}
                    onUpdateTarget={handleUpdateTarget}
                    onDeleteTarget={handleDeleteTarget}
                    onSave={handleSaveEntry} 
                    onCancel={() => setView(AppView.DASHBOARD)} 
                  />
                )}
              </main>

              <footer className="bg-white border-t border-gray-200 py-6 mt-8">
                <div className="max-w-5xl mx-auto px-4 text-center text-sm text-gray-500">
                  <p>&copy; {new Date().getFullYear()} ASUS Competitor Intelligence.</p>
                </div>
              </footer>
            </div>
          );
        };

        // --- RENDER ROOT ---
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
    </script>
</body>
</html>
