import React, { useState, useRef } from 'react';
import { Camera, X, Loader2, Save, ArrowLeft, CheckCircle2, ChevronRight, PlusCircle, Pencil, Trash2 } from 'lucide-react';
import { CompetitorEntry, TargetModel, COMMON_BRANDS } from '../types';
import { extractDataFromImage } from '../services/geminiService';

interface EntryFormProps {
  availableTargets: TargetModel[];
  onCreateTarget: (target: TargetModel) => void;
  onUpdateTarget: (target: TargetModel) => void;
  onDeleteTarget: (id: string) => void;
  onSave: (entry: CompetitorEntry) => void;
  onCancel: () => void;
}

const EntryForm: React.FC<EntryFormProps> = ({ availableTargets, onCreateTarget, onUpdateTarget, onDeleteTarget, onSave, onCancel }) => {
  // Step 1: Selection, Step 2: Form
  const [step, setStep] = useState<1 | 2>(1);
  
  // Target Management State
  const [targetFormMode, setTargetFormMode] = useState<'none' | 'create' | 'edit'>('none');
  const [editingTargetId, setEditingTargetId] = useState<string | null>(null);
  
  // New/Edit Target Form State
  const [targetBrand, setTargetBrand] = useState('');
  const [targetModel, setTargetModel] = useState('');

  // Selected Target (for entering price)
  const [selectedTarget, setSelectedTarget] = useState<{brand: string, model: string} | null>(null);

  // Price Entry Form State
  const [finalMSRP, setFinalMSRP] = useState<string>('');
  const [promotion, setPromotion] = useState('');
  const [imagePreview, setImagePreview] = useState<string | null>(null);
  
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  const fileInputRef = useRef<HTMLInputElement>(null);

  // STEP 1: Handle Target Selection
  const handleTargetSelect = (target: {brand: string, model: string}) => {
    setSelectedTarget(target);
    setStep(2);
  };

  // Start Creating New Target
  const startCreateTarget = () => {
    setTargetBrand('');
    setTargetModel('');
    setEditingTargetId(null);
    setTargetFormMode('create');
  };

  // Start Editing Existing Target
  const startEditTarget = (target: TargetModel) => {
    setTargetBrand(target.brand);
    setTargetModel(target.model);
    setEditingTargetId(target.id);
    setTargetFormMode('edit');
  };

  // Handle Target Form Submit (Create or Update)
  const handleTargetFormSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!targetBrand || !targetModel) return;

    if (targetFormMode === 'create') {
        const newTarget: TargetModel = {
            id: crypto.randomUUID(),
            brand: targetBrand,
            model: targetModel
        };
        onCreateTarget(newTarget);
        // Auto-select newly created target
        setSelectedTarget({ brand: targetBrand, model: targetModel });
        setStep(2);
    } else if (targetFormMode === 'edit' && editingTargetId) {
        onUpdateTarget({
            id: editingTargetId,
            brand: targetBrand,
            model: targetModel
        });
        setTargetFormMode('none');
        setEditingTargetId(null);
    }
  };

  // STEP 2: Handle File selection and AI
  const handleFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onloadend = async () => {
      const base64String = reader.result as string;
      setImagePreview(base64String);
      await analyzeImage(base64String.split(',')[1]);
    };
    reader.readAsDataURL(file);
  };

  const analyzeImage = async (base64Data: string) => {
    setIsAnalyzing(true);
    setError(null);
    try {
      const data = await extractDataFromImage(base64Data);
      
      // Only auto-fill Price and Promo. Brand/Model are locked.
      if (data.finalMSRP) setFinalMSRP(data.finalMSRP.toString());
      if (data.promotion) setPromotion(data.promotion);
      
    } catch (err) {
      setError("Could not analyze image. Please enter price manually.");
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!selectedTarget || !finalMSRP) {
      setError("Please fill in price.");
      return;
    }

    const newEntry: CompetitorEntry = {
      id: crypto.randomUUID(),
      date: new Date().toISOString(),
      brand: selectedTarget.brand,
      modelName: selectedTarget.model,
      finalMSRP: parseFloat(finalMSRP),
      promotion: promotion || 'None',
      imageUrl: imagePreview || undefined
    };

    onSave(newEntry);
  };

  // RENDER STEP 1: Target Selection / Management
  if (step === 1) {
    // Show Create/Edit Form
    if (targetFormMode !== 'none') {
      return (
        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div className="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50">
            <button onClick={() => setTargetFormMode('none')} className="text-gray-500 hover:text-gray-700 flex items-center gap-1 text-sm font-medium">
              <ArrowLeft size={16} /> Cancel
            </button>
            <h2 className="text-lg font-semibold text-gray-800">
                {targetFormMode === 'create' ? 'Add New Model' : 'Edit Model'}
            </h2>
            <div className="w-12"></div>
          </div>
          <div className="p-6">
            <form onSubmit={handleTargetFormSubmit} className="space-y-4">
               <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Brand Name</label>
                <input
                  list="brands"
                  type="text"
                  required
                  value={targetBrand}
                  onChange={(e) => setTargetBrand(e.target.value)}
                  placeholder="e.g. Razer"
                  className="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
                <datalist id="brands">
                  {COMMON_BRANDS.map(b => <option key={b} value={b} />)}
                </datalist>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Model Name / Number</label>
                <input
                  type="text"
                  required
                  value={targetModel}
                  onChange={(e) => setTargetModel(e.target.value)}
                  placeholder="e.g. Blade 14 (2024)"
                  className="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                />
              </div>
              <button
                type="submit"
                className="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 shadow-sm mt-4"
              >
                {targetFormMode === 'create' ? 'Create & Select' : 'Save Changes'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    // Show Selection List
    return (
      <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div className="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50">
          <button onClick={onCancel} className="text-gray-500 hover:text-gray-700 flex items-center gap-1 text-sm font-medium">
            <ArrowLeft size={16} /> Back
          </button>
          <h2 className="text-lg font-semibold text-gray-800">Select Target Model</h2>
          <div className="w-12"></div>
        </div>
        
        <div className="p-4">
          <button 
            onClick={startCreateTarget}
            className="w-full flex items-center justify-center gap-2 p-3 mb-4 rounded-lg border-2 border-dashed border-blue-300 text-blue-600 bg-blue-50 hover:bg-blue-100 transition-colors font-semibold"
          >
            <PlusCircle size={20} />
            Create New Model
          </button>

          <p className="text-xs text-gray-500 mb-2 px-2 uppercase font-semibold tracking-wider">Existing Targets</p>
          <div className="space-y-3">
            {availableTargets.map((target, idx) => (
              <div 
                key={target.id || idx} 
                className="w-full flex items-center p-3 rounded-lg border border-gray-200 hover:border-blue-400 hover:bg-blue-50 transition-all bg-white group shadow-sm"
              >
                <button 
                    onClick={() => handleTargetSelect(target)}
                    className="flex-1 text-left"
                >
                    <div className="font-semibold text-gray-900 group-hover:text-blue-700">{target.model}</div>
                    <div className="text-sm text-gray-500">{target.brand}</div>
                </button>
                
                <div className="flex items-center gap-1 border-l border-gray-200 pl-3 ml-2">
                    <button 
                        onClick={(e) => { e.stopPropagation(); startEditTarget(target); }}
                        className="p-2 text-gray-400 hover:text-blue-600 hover:bg-white rounded-md transition-colors"
                        title="Edit Model"
                    >
                        <Pencil size={18} />
                    </button>
                    <button 
                        onClick={(e) => { e.stopPropagation(); onDeleteTarget(target.id); }}
                        className="p-2 text-gray-400 hover:text-red-600 hover:bg-white rounded-md transition-colors"
                        title="Delete Model"
                    >
                        <Trash2 size={18} />
                    </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // RENDER STEP 2: Data Entry (Price/Promo)
  return (
    <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <div className="p-4 border-b border-gray-100 flex items-center justify-between bg-gray-50">
        <button 
          onClick={() => setStep(1)}
          className="text-gray-500 hover:text-gray-700 flex items-center gap-1 text-sm font-medium"
        >
          <ArrowLeft size={16} /> Change Model
        </button>
        <h2 className="text-lg font-semibold text-gray-800">Update Price</h2>
        <div className="w-12"></div>
      </div>

      <div className="p-6">
        {/* Selected Model Summary */}
        <div className="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-6 flex items-start gap-3">
            <CheckCircle2 className="text-blue-600 mt-0.5" size={20} />
            <div>
                <p className="text-xs text-blue-600 font-bold uppercase tracking-wider">Target Model</p>
                <h3 className="text-lg font-bold text-gray-900">{selectedTarget?.model}</h3>
                <p className="text-sm text-gray-600">{selectedTarget?.brand}</p>
            </div>
        </div>

        {/* AI Camera Section */}
        <div className="mb-8">
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Scan Price Tag (Optional)
          </label>
          <div 
            onClick={() => fileInputRef.current?.click()}
            className={`
              relative border-2 border-dashed rounded-lg p-6 flex flex-col items-center justify-center cursor-pointer transition-colors
              ${imagePreview ? 'border-blue-300 bg-blue-50' : 'border-gray-300 hover:border-blue-400 hover:bg-gray-50'}
            `}
          >
            <input 
              type="file" 
              ref={fileInputRef} 
              className="hidden" 
              accept="image/*" 
              capture="environment" 
              onChange={handleFileChange}
            />
            
            {isAnalyzing ? (
              <div className="text-center py-4">
                <Loader2 className="animate-spin h-10 w-10 text-blue-600 mx-auto mb-2" />
                <p className="text-blue-700 font-medium">Extracting Price...</p>
              </div>
            ) : imagePreview ? (
              <div className="relative w-full max-h-48 flex justify-center">
                 <img src={imagePreview} alt="Preview" className="max-h-48 rounded-md object-contain" />
                 <button 
                    onClick={(e) => { e.stopPropagation(); setImagePreview(null); setFinalMSRP(''); setPromotion(''); }}
                    className="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full shadow-md hover:bg-red-600"
                 >
                   <X size={16} />
                 </button>
              </div>
            ) : (
              <div className="text-center">
                <div className="bg-blue-100 p-3 rounded-full inline-flex mb-3 text-blue-600">
                  <Camera size={24} />
                </div>
                <p className="text-gray-900 font-medium">Tap to take photo</p>
              </div>
            )}
          </div>
          {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
        </div>

        {/* Manual Entry Form */}
        <form onSubmit={handleSubmit} className="space-y-5">
          <div className="grid grid-cols-2 gap-4">
            <div>
                <label className="block text-sm font-medium text-gray-500 mb-1">Brand</label>
                <input
                type="text"
                value={selectedTarget?.brand}
                readOnly
                className="w-full rounded-md border border-gray-200 bg-gray-100 px-3 py-2 text-gray-500 cursor-not-allowed"
                />
            </div>
            <div>
                <label className="block text-sm font-medium text-gray-500 mb-1">Model</label>
                <input
                type="text"
                value={selectedTarget?.model}
                readOnly
                className="w-full rounded-md border border-gray-200 bg-gray-100 px-3 py-2 text-gray-500 cursor-not-allowed"
                />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Final MSRP ($) *</label>
            <input
                type="number"
                value={finalMSRP}
                onChange={(e) => setFinalMSRP(e.target.value)}
                placeholder="0.00"
                className="w-full rounded-md border border-gray-300 px-3 py-2 text-lg font-medium text-gray-900 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
                autoFocus
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Other Promotion / Notes</label>
            <textarea
              value={promotion}
              onChange={(e) => setPromotion(e.target.value)}
              placeholder="e.g. Free backpack, 5% off student discount"
              rows={3}
              className="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>

          <div className="pt-4 flex gap-3">
             <button
              type="button"
              onClick={onCancel}
              className="flex-1 bg-white text-gray-700 border border-gray-300 px-4 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              className="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 shadow-sm flex justify-center items-center gap-2 transition-colors"
            >
              <Save size={18} />
              Save
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default EntryForm;
